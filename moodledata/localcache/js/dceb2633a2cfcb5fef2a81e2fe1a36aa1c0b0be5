
/**
 * Javascript helper function for OUBlog.
 *
 * @package    mod
 * @subpackage oublog
 * @copyright  2013 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
M.mod_oublog=M.mod_oublog||{};M.mod_oublog.init=function(Y){M.mod_oublog.hidewarning(Y);var comments=Y.one('#id_allowcomments');if(comments){comments.on('change',function(e){M.mod_oublog.hidewarning(Y)})}};M.mod_oublog.hidewarning=function(Y){var field=Y.one('#publicwarningmarker');if(field){field=field.get('parentNode').get('parentNode');var select=Y.one('#id_allowcomments');field.setStyle('display',select.get('value')==2?'block':'none')}};M.mod_oublog.init_showhide=function(Y,name,curpref){var block=Y.one('.oublog_statsview_content_'+name);if(block){var showhide=block.one('.block_action_oublog');var form=block.one('form.mform');if(showhide&&form){var hideinfo=block.one('.oublog_stats_minus');var showinfo=block.one('.oublog_stats_plus');if(curpref==1){form.addClass('oublog_displaynone');hideinfo.addClass('oublog_displaynone');showinfo.removeClass('oublog_displaynone')}
showhide.on(['click','keypress'],function(e){if(!e.keyCode||(e.keyCode&&e.keyCode==13)){e.preventDefault();if(curpref==1){hideinfo.removeClass('oublog_displaynone');showinfo.addClass('oublog_displaynone');form.removeClass('oublog_displaynone');if(!Y.one('body').hasClass('notloggedin')){M.util.set_user_preference('mod_oublog_hidestatsform_'+name,0)}
curpref=0}else{hideinfo.addClass('oublog_displaynone');showinfo.removeClass('oublog_displaynone');form.addClass('oublog_displaynone');if(!Y.one('body').hasClass('notloggedin')){M.util.set_user_preference('mod_oublog_hidestatsform_'+name,1)}
curpref=1}}})}}};M.mod_oublog.init_deleteandemail=function(Y,cmid,postid){this.Y=Y;this.YAHOO=Y.YUI2;var delbtns=Y.one('a.oublog_deleteandemail_'+postid);delbtns.on('click',function(e){var uri=e.target.get('href');delbtns.set('disabled',!1);var content=M.util.get_string('deleteemailpostdescription','oublog');var panel=new M.core.dialogue({bodyContent:content,width:400,centered:!0,render:!0,zIndex:50,buttons:{},plugins:[Y.Plugin.Drag],modal:!0});panel.addButton({label:M.util.get_string('delete','oublog'),section:Y.WidgetStdMod.FOOTER,action:function(e){e.preventDefault();uri+='&confirm=1';document.location.href=uri;panel.hide();panel.destroy()}});panel.addButton({label:M.util.get_string('deleteandemail','oublog'),section:Y.WidgetStdMod.FOOTER,action:function(e){e.preventDefault();uri+='&email=1';document.location.href=uri;panel.hide();panel.destroy()}});panel.addButton({value:'Cancel',section:Y.WidgetStdMod.FOOTER,action:function(e){e.preventDefault();panel.hide();panel.destroy();Y.one('a.oublog_deleteandemail_'+postid).focus()}});e.preventDefault();Y.one('a.oublog_deleteandemail_'+postid).focus();panel.show()})};M.mod_oublog.init_posttable=function(Y){var includehead=Y.one('.flexible .header.c3');var postchecks=Y.all('.flexible td.c3 input[type=checkbox]');if(includehead&&postchecks){includehead.append('<a href="#" class="oublog_import_all">'+M.util.get_string('import_step1_all','oublog')+'</a> / <a href="#" class="oublog_import_none">'+M.util.get_string('import_step1_none','oublog')+'</a>');var all=Y.one('.flexible .c3 .oublog_import_all');if(all){all.on('click',function(e){postchecks.set('checked',!0);postchecks.each(function(check){updatepreselect(check)});e.preventDefault();return!1})}
var none=Y.one('.flexible .c3 .oublog_import_none');if(none){none.on('click',function(e){postchecks.set('checked',!1);postchecks.each(function(check){updatepreselect(check)});e.preventDefault();return!1})}}
var updatepreselect=function(check){var preselect=preselectinput.get('value');var id=check.get('name').substr(5);if(check.get('checked')){if(id){var prearray=preselect.split(',');for(var i=0,len=prearray.length;i<len;i++){if(prearray[i]==id){return}}
prearray.push(id);preselectinput.set('value',prearray.join());updatelinks(prearray)}}else{if(preselect&&id){var prearray=preselect.split(',');for(var i=0,len=prearray.length;i<len;i++){if(prearray[i]==id){prearray.splice(i,1);preselectinput.set('value',prearray.join());updatelinks(prearray);return}}}}};var updatelinks=function(prearray){Y.all('.oublog_import_step1 form .paging a, .flexible a').each(function(link){var linkurl=link.get('href');var params=Y.QueryString.parse(linkurl.substr(linkurl.indexOf('&')));params.preselected=prearray.join();var newurl=Y.QueryString.stringify(params);link.set('href',linkurl.substr(0,linkurl.indexOf('&'))+'&'+newurl)})};var preselectinput=Y.one('form input[name=preselected]');if(postchecks&&preselectinput){postchecks.on('click',function(check){updatepreselect(check.target)})}}